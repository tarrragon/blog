---
title: "Ticket 生命週期流程 - AI 協作開發的任務管理系統"
date: 2026-02-02
draft: false
description: "定義 Ticket 從建立到完成的完整生命週期，包含狀態管理、驗收流程、任務鏈設計和與 TDD 流程的整合"
tags: ["Ticket", "任務管理", "專案管理", "TDD", "驗收流程", "AI協作", "開發流程"]
---

本文件定義 Ticket 從建立到完成的完整生命週期。這套系統是我在 AI 協作開發（Claude Code）過程中逐步建立的任務追蹤機制。

## 為什麼需要 Ticket 生命週期管理？

在 AI 協作開發中，任務的追蹤和管理變得更加重要：

1. **責任歸屬明確**：每個任務都有明確的建立者、認領者和驗收者
2. **狀態可追蹤**：從 pending 到 completed，每個階段都有清晰定義
3. **品質保證**：透過驗收流程確保任務達到預期標準
4. **任務鏈管理**：複雜任務可以拆分成子任務，保持關聯性

## 生命週期總覽

```
需求/問題產生
    |
    v
建立 Ticket (/ticket create)
    |
    v
Ticket 狀態: pending
    |
    v
認領 Ticket (/ticket track claim)
    |
    v
Ticket 狀態: in_progress
    |
    +-- 正常完成 --> /ticket track complete --> 狀態: completed
    |
    +-- 無法繼續 --> /ticket track release --> 狀態: blocked
    |                                              |
    |                                              v
    |                                         升級到 PM 處理
    |
    v
完成
```

## Ticket 狀態定義

| 狀態 | 說明 | 允許操作 |
|------|------|---------|
| pending | 等待處理 | claim |
| in_progress | 處理中 | complete, release |
| completed | 已完成 | - |
| blocked | 被阻塞 | claim（重新認領） |

## 階段-標準流程對照表

每個生命週期階段都有對應的標準流程和提示，防止關鍵步驟被遺漏。

### 建立階段

| 標準流程 | 提示強度 | 說明 |
|---------|---------|------|
| SA 前置審查評估 | 建議 | 新功能/架構變更時需要 SA 審查 |
| 任務拆分評估 | 建議 | 認知負擔 > 10 時需要拆分 |
| 驗收條件 4V 檢查 | 建議 | 確保驗收條件可驗證、可量化、可追溯、可記錄 |
| blockedBy 設定 | 提示 | 提醒設定依賴關係 |
| decision_tree_path 填寫 | 建議 | 派發驗證必需 |

### 認領階段

| 標準流程 | 提示強度 | 說明 |
|---------|---------|------|
| 阻塞依賴檢查 | 警告 | 如有阻塞依賴，顯示警告 |
| 設計文件閱讀 | 建議 | 提醒閱讀相關規格和設計 |
| 驗收條件理解 | 建議 | 確保理解驗收標準 |
| error-patterns 查詢 | 建議 | IMP/ADJ 類型時建議查詢 |

### 執行階段

| 標準流程 | 提示強度 | 說明 |
|---------|---------|------|
| 問題派發 incident-responder | 強制 | 遇到錯誤時強制派發 |
| 工作日誌更新 | 建議 | 執行過程記錄 |

### 完成階段

| 標準流程 | 提示強度 | 說明 |
|---------|---------|------|
| 驗收條件勾選確認 | 建議 | 所有條件必須勾選 |
| 建議處理確認 | 建議 | 無 pending 建議 |
| **派發 acceptance-auditor** | **強制** | **IMP/ADJ 類型必須執行驗收** |
| 任務鏈後續步驟建議 | 提示 | 分析並建議下一個 Ticket |

### 驗收後階段

| 標準流程 | 提示強度 | 說明 |
|---------|---------|------|
| 技術債務記錄 | 建議 | 如有 TD 需記錄 |
| CHANGELOG 更新 | 建議 | 版本發布時 |
| 學習經驗記錄 | 提示 | 派發 memory-network-builder |
| 任務鏈進度更新 | 自動 | 顯示任務鏈完成度 |

### 提示強度說明

| 強度 | 說明 | 行為 |
|------|------|------|
| **強制** | 必須執行，否則阻止繼續 | Hook 阻止操作 |
| **警告** | 重要提醒，應優先處理 | 顯示 [WARNING] 標記 |
| **建議** | 強烈建議，但可跳過 | 顯示檢查清單 |
| **提示** | 輕量提醒，視情況執行 | 顯示提示訊息 |

## 任務鏈後續步驟建議

當 Ticket 完成時，系統會自動分析任務鏈狀態並建議下一步。

### 分析優先級

| 優先級 | 情境 | 建議內容 |
|--------|------|---------|
| 1 | 有子 Ticket 可開始 | 「子 Ticket {id} 現在可以開始」 |
| 2 | 有被解除阻塞的 Ticket | 「{id} 的阻塞已解除」 |
| 3 | 有同層兄弟 Ticket | 「同層還有 {id} 待處理」 |
| 4 | 同 Wave 有其他 pending | 「同 Wave 還有 N 個待處理」 |
| 5 | 任務鏈全部完成 | 「任務鏈 {root} 全部完成」 |

### 輸出範例

```
============================================================
[任務鏈後續步驟建議]
============================================================

已完成: 0.31.0-W4-007.1
        [實作 track P0 功能]

任務鏈進度: 1/3 completed
   Root: 0.31.0-W4-007

建議下一步:
   1. 0.31.0-W4-007.2
      [實作 track P1 功能]
      原因: 阻塞已解除（blockedBy 0.31.0-W4-007.1 已完成）
      狀態: pending → 可認領
```

## 任務鏈 ID 格式

### 格式規範

| 類型 | 格式 | 範例 |
|------|------|------|
| 根任務 | `{版本}-W{波次}-{序號}` | `0.31.0-W3-002` |
| 子任務 | `{根ID}.{n}[.{n}...]` | `0.31.0-W3-002.1.1` |

### 正則表達式

```regex
# 完整匹配（支援無限深度）
^(\d+\.\d+\.\d+)-W(\d+)-(\d+(?:\.\d+)*)$
```

### 範例任務鏈

```
0.31.0-W3-002              # ticket-handoff 功能（根）
├── 0.31.0-W3-002.1        # chain_analyzer 模組
│   ├── 0.31.0-W3-002.1.1  # 問題修復
│   └── 0.31.0-W3-002.1.2  # 測試補充
├── 0.31.0-W3-002.2        # handoff_executor 模組
└── 0.31.0-W3-002.3        # 文件更新
```

### chain 欄位說明

| 欄位 | 類型 | 說明 |
|------|------|------|
| root | string | 任務鏈根 ID |
| parent | string/null | 直接父任務 ID |
| depth | number | 深度（根=0） |
| sequence | array | 序號路徑陣列 |

### 範例 chain 欄位

**根任務**（`0.31.0-W3-002`）：
```yaml
chain:
  root: "0.31.0-W3-002"
  parent: null
  depth: 0
  sequence: [2]
```

**子任務**（`0.31.0-W3-002.1.1`）：
```yaml
chain:
  root: "0.31.0-W3-002"
  parent: "0.31.0-W3-002.1"
  depth: 2
  sequence: [2, 1, 1]
```

## Ticket 建立流程

### 建立時機

| 時機 | 建立者 |
|------|-------|
| 新功能需求 | rosemary-project-manager |
| 錯誤分析後 | incident-responder |
| 階段任務開始 | rosemary-project-manager |
| 技術債務記錄 | cinnamon-refactor-owl |

### 強制規則：使用命令建立 Ticket

> **禁止直接使用 Write 工具建立 Ticket 檔案**

| 規則 | 說明 |
|------|------|
| **必須使用命令** | 所有 Ticket 必須透過 `/ticket create` 命令建立 |
| **禁止直接寫入** | 禁止使用 Write/Edit 工具直接建立 `.md` Ticket 檔案 |
| **唯一存放路徑** | `docs/work-logs/v{version}/tickets/`（無其他備用路徑） |
| **子任務建立** | 使用 `/ticket create --parent {parent_id}` |

**正確範例**：
```bash
# 建立新 Ticket
/ticket create

# 建立子任務
/ticket create --parent 0.31.0-W4-036
```

### 任務層級判斷

建立 Ticket 前，必須先判斷任務層級。

**核心判斷問題**：「這個任務是在執行哪個 Ticket 時產生的？」

```
任務層級判斷
    |
    v
這個任務是否因為執行現有 Ticket 而產生？
    |
    +-- 是 → 來源 Ticket 是什麼？
    |       |
    |       └── 確定來源 Ticket ID → 建立該 Ticket 的子任務
    |           ├── 來源: 010.4 → 子任務 ID: 010.4.x
    |           ├── 來源: 010.4.1 → 子任務 ID: 010.4.1.x
    |           └── 來源: 010 → 子任務 ID: 010.x
    |
    └-- 否 → 建立新任務鏈（新的 Wx-00n）
```

**判斷規則表**：

| 情境 | 來源 Ticket | 新 Ticket ID | 範例 |
|------|------------|-------------|------|
| 執行 Ticket 時發現問題 | 明確 | {來源}.{n} | 執行 010.4 發現問題 → 010.4.x |
| 執行子任務時發現問題 | 明確 | {來源子任務}.{n} | 執行 010.4.1 發現問題 → 010.4.1.x |
| 用戶提出新需求 | 無 | 新任務鏈 | 新功能需求 → 新的 Wx-00n |
| 發現的獨立系統問題 | 無 | 新任務鏈 | 系統級問題 → 新的 Wx-00n |

**識別特徵**：

| 應建立子任務 | 應建立新任務鏈 |
|-------------|---------------|
| 問題在執行特定 Ticket 時發現 | 問題與任何執行中的 Ticket 無關 |
| 問題直接影響該 Ticket 的完成 | 問題是系統性的獨立問題 |
| 「執行 X 時發現 Y 問題」 | 「發現系統有 Z 問題」 |

### 建立格式

```markdown
---
id: {版本}-W{波次}-{序號}
title: {動詞} {目標}
type: IMP/RES/ANA/INV/DOC
status: pending
priority: P0/P1/P2
assignee: pending
created: {日期}
---

# {Ticket ID}: {標題}

## 目標
{目標描述}

## 驗收條件
- [ ] {條件1}
- [ ] {條件2}
```

### Atomic Ticket 檢查

| 檢查項目 | 標準 |
|---------|------|
| 語義檢查 | 能用「動詞 + 單一目標」表達 |
| 修改原因 | 只有一個修改原因 |
| 驗收一致 | 所有驗收條件指向同一目標 |
| 依賴獨立 | 無循環依賴 |

### 驗收條件格式要求

驗收條件必須符合 4V 原則：**可驗證、可量化、可追溯、可記錄**。

| 要求 | 說明 | 範例 |
|------|------|------|
| 必須有編號 | 每個驗收項目都有編號 | `1.`, `2.`, ... |
| 必須有來源 | 引用設計文件或需求 | `SKILL.md L97` |
| 必須有確認方法 | 定義如何驗證完成 | `執行命令驗證輸出` |
| 禁止模糊詞彙 | 不可用「完成」「正常」「適當」 | 用具體描述取代 |

**標準格式（表格式）**：

```markdown
## Acceptance Criteria

| # | 項目 | 來源 | 確認方法 | 狀態 |
|---|------|------|---------|------|
| 1 | {項目描述} | {來源引用} | {確認方法} | [ ] |
| 2 | {項目描述} | {來源引用} | {確認方法} | [ ] |
```

## Ticket 有效性驗證

### 有效 Ticket 定義

有效的 Ticket 必須滿足以下條件：

| 條件 | 說明 | 驗證方式 |
|------|------|---------|
| 決策樹欄位 | 包含 `decision_tree_path` 欄位 | YAML frontmatter 檢查 |
| 或決策樹區段 | 包含「## 決策樹路徑」Markdown 區段 | 內容檢查 |

### 驗證時機

| 時機 | 驗證者 | 動作 |
|------|-------|------|
| 建立 Ticket | /ticket create | 自動要求填寫決策樹欄位 |
| 派發任務 | agent-ticket-validation-hook | 阻止使用無效 Ticket |
| 認領 Ticket | /ticket track claim | 確認 Ticket 有效性 |

### 無效 Ticket 處理

無效 Ticket（缺少決策樹欄位）：
- 無法用於 Task 派發（被 Hook 阻止）
- 需要補充決策樹欄位才能使用
- 建議使用 /ticket create 重新建立

### 補充決策樹欄位

如果 Ticket 缺少決策樹欄位，可手動補充：

1. **YAML 格式**（在 frontmatter 中）：

```yaml
decision_tree_path:
  entry_point: "第X層"
  decision_nodes:
    - layer: "X"
      question: "決策問題"
      answer: "答案"
      next_action: "下一步"
  final_decision: "最終決策"
  rationale: "決策理由"
```

2. **Markdown 格式**（在內容中）：

```markdown
## 決策樹路徑

### 進入點
- **層級**: 第X層
- **觸發條件**: ...
```

## Ticket 認領流程

```bash
/ticket track claim {ticket-id}
```

### 認領規則

| 規則 | 說明 |
|------|------|
| 單一認領 | 同一時間只能有一個代理人處理 |
| 階段匹配 | 只能認領對應階段的 Ticket |
| 依賴檢查 | 前置 Ticket 必須完成 |

## Ticket 執行流程

```
認領 Ticket
    |
    v
執行對應階段工作
    |
    v
更新工作日誌
    |
    v
驗證驗收條件
    |
    +-- 全部通過 --> 完成 Ticket
    +-- 部分通過 --> 繼續處理或升級
    +-- 無法完成 --> 釋放 Ticket
```

## Ticket 完成流程

```bash
/ticket track complete {ticket-id}
```

### 「先查後做」驗證流程

> **重要**：執行 complete 前，系統會自動進行四步驟驗證，確保 Ticket 處於可完成狀態。

```
執行 /ticket track complete {id}
    |
    v
Step 1: 載入 Ticket
    |
    +-- 找不到 --> [Error] 錯誤訊息，exit 1
    |
    v
Step 2: 驗證狀態
    |
    +-- completed --> [Info] 友好訊息「已完成於...」，exit 0
    +-- pending --> [Error] 阻止「尚未被接手」，exit 1
    +-- blocked --> [Error] 阻止「被阻塞」，exit 1
    +-- in_progress --> 繼續驗證
    |
    v
Step 3: 驗證驗收條件
    |
    +-- 有未完成項 --> [Error] 阻止並列出未完成項，exit 1
    |
    v
Step 4: 執行完成操作
    |
    v
[OK] 完成成功，exit 0
```

### 驗證結果對應表

| 情境 | 驗證結果 | 訊息類型 | Exit Code |
|------|---------|---------|-----------|
| Ticket 不存在 | 阻止 | Error | 1 |
| 狀態為 pending | 阻止 | Error（提示先 claim） | 1 |
| 狀態為 blocked | 阻止 | Error | 1 |
| 狀態為 completed | 允許（友好提示） | Info | 0 |
| 驗收條件未全部完成 | 阻止 | Error（列出未完成項） | 1 |
| 正常完成 | 允許 | OK | 0 |

### 完成檢查

| 檢查項目 | 標準 |
|---------|------|
| 驗收條件 | 所有條件都已勾選 |
| 測試通過 | 相關測試全部通過 |
| 文件更新 | 相關文件已更新 |
| 工作日誌 | 執行記錄完整 |

### 驗收代理人流程

> **核心原則**：所有 Ticket 都必須驗收，驗收是契約的履行。

```
執行者完成工作
    |
    v
自我檢查驗收條件
    |
    v
執行 /ticket track complete {id}
    |
    v
[系統判斷] 任務類型?
    |
    +-- IMP/ADJ/複雜/安全 --> [PM] 派發 acceptance-auditor
    |                               |
    |                               v
    |                          驗收代理人執行驗收
    |                               |
    |                               +-- 驗收通過 --> 正式完成
    |                               |
    |                               +-- 驗收失敗 --> 回到執行者修正
    |
    +-- DOC/簡單任務 --> [PM] 直接驗收
                              |
                              +-- 驗收通過 --> 正式完成
                              |
                              +-- 驗收失敗 --> 回到執行者修正
```

### 驗收執行規則

> **核心原則**：驗收是契約的履行，所有 Ticket 都必須驗收，無豁免機制。

#### 驗收執行方式

根據任務類型決定驗收執行方式：

| 任務類型 | 驗收執行者 | 說明 |
|---------|-----------|------|
| IMP 類型 | acceptance-auditor | 實作任務需獨立驗收 |
| ADJ 類型 | acceptance-auditor | 調整任務需獨立驗收 |
| TDD Phase 完成 | acceptance-auditor | 確保品質 |
| 複雜功能 | acceptance-auditor | 高風險任務 |
| 涉及安全相關 | acceptance-auditor + security-reviewer | 安全審查 + 驗收 |
| DOC 類型 | PM 直接驗收 | 簡單任務由 PM 確認 |
| 簡單任務（認知負擔 < 5） | PM 直接驗收 | 簡單任務由 PM 確認 |

#### P0 緊急任務處理

P0 緊急任務可「先完成後補驗收」，這不是豁免，而是時間順序調整：

```
P0 緊急任務
    |
    v
執行者完成工作（優先響應）
    |
    v
標記「待補驗收」
    |
    v
[後續] PM 派發驗收（24 小時內）
    |
    v
驗收完成 → 正式完成
```

## Ticket 釋放流程

### 釋放時機

| 時機 | 說明 |
|------|------|
| 被阻塞 | 依賴其他 Ticket 完成 |
| 超出範圍 | 發現需要額外工作 |
| 技術限制 | 當前無法解決 |
| 資訊不足 | 需要更多資訊 |

```bash
/ticket track release {ticket-id}
```

## Ticket 類型說明

| 類型 | 代碼 | 用途 | 典型時長 |
|------|------|------|---------|
| Research | RES | 探索未知領域 | 1-2 小時 |
| Analysis | ANA | 理解現狀和問題 | 30 分鐘 - 1 小時 |
| Implementation | IMP | 執行具體任務 | 1-4 小時 |
| Investigation | INV | 深入追蹤問題根因 | 1-2 小時 |
| Documentation | DOC | 記錄和傳承經驗 | 30 分鐘 - 1 小時 |

## Ticket 追蹤命令

| 命令 | 用途 |
|------|------|
| `/ticket track summary` | 查詢所有 Ticket 進度 |
| `/ticket track query {id}` | 查詢特定 Ticket 詳情 |
| `/ticket track claim {id}` | 認領 Ticket |
| `/ticket track complete {id}` | 完成 Ticket |
| `/ticket track release {id}` | 釋放 Ticket |
| `/ticket track list` | 列出當前版本 Ticket |

## 與其他流程的整合

### 與 TDD 流程整合

```
Phase 0 Ticket (SA 審查)
    ↓
Phase 1 Ticket (功能設計)
    ↓
Phase 2 Ticket (測試設計)
    ↓
Phase 3a Ticket (策略規劃)
    ↓
Phase 3b Ticket (實作執行)
    ↓
Phase 4 Ticket (重構優化)
```

### 與事件回應流程整合

incident-responder 分析 → 建立錯誤修復 Ticket → 派發對應代理人

### 與技術債務流程整合

Phase 4 發現技術債務 → 記錄到工作日誌 → /tech-debt-capture → 建立技術債務 Ticket

### 與建議追蹤流程整合

調查/分析報告產生建議 → 記錄到 Suggestion Tracking → 處理每個建議（採納/拒絕/延後） → 採納的建議轉為驗收條件

#### 建議追蹤狀態

| 狀態 | 說明 | 要求 |
|------|------|------|
| pending | 待決定 | 必須在任務執行前處理 |
| adopted | 採納 | 必須轉為驗收條件 |
| rejected | 拒絕 | 必須記錄拒絕理由 |
| deferred | 延後 | 必須記錄目標版本 |

#### 建議追蹤格式

```markdown
## Suggestion Tracking

### 來源：{來源文件}

| # | 建議內容 | 狀態 | 決定理由 | 對應 AC | 決定者 | 決定時間 |
|---|---------|------|---------|--------|--------|---------|
| 1 | {內容} | adopted | {理由} | AC-001 | PM | 2026-01-30 |
```

## 設計理念

這套 Ticket 生命週期系統的設計理念：

1. **契約式驗收**：所有 Ticket 都必須驗收，驗收是契約的履行，不應有可省略的部分
2. **狀態明確**：每個狀態只能執行特定操作，避免狀態混亂
3. **先查後做**：完成前先驗證，確保 Ticket 處於可完成狀態
4. **任務鏈管理**：複雜任務拆分成子任務，保持關聯性和追蹤性
5. **與 TDD 整合**：每個 TDD Phase 對應一個 Ticket，確保流程完整

## 版本歷史

- v2.8.0 (2026-02-01): 取消驗收豁免機制，改為契約式驗收
- v2.7.0 (2026-02-01): 強化驗收代理人派發要求
- v2.6.0 (2026-01-31): 新增任務層級判斷規則
- v2.5.0 (2026-01-30): 新增階段-標準流程對照表和任務鏈後續步驟建議
- v2.4.0 (2026-01-30): 新增建議追蹤流程整合章節
- v2.3.0 (2026-01-30): 新增驗收條件格式要求章節
- v2.2.0 (2026-01-29): 新增任務鏈 ID 格式章節
- v2.1.0 (2026-01-27): 新增 Ticket 有效性驗證章節
- v2.0.0 (2026-01-23): 重構為 TDD 含 SA 前置審查流程版本
