{{ define "main" }}
<!-- å´é‚Šç« ç¯€å°èˆª - ç¨ç«‹æ–¼ä¸»å…§å®¹å€åŸŸ -->
<aside class="toc-sidebar">
  <h3>ğŸ“‹ ç« ç¯€ç›®éŒ„</h3>
  {{ if .TableOfContents }}
    {{ .TableOfContents }}
  {{ else }}
    <p style="color: rgba(255, 255, 255, 0.5); font-size: 0.85rem; margin: 0;">
      æ­¤æ–‡ç« æ²’æœ‰ç« ç¯€æ¨™é¡Œ
    </p>
  {{ end }}
</aside>

<!-- æ–‡ç« å…§å®¹ - ä¿æŒåŸæœ‰çš„ç½®ä¸­ä½ˆå±€ -->
<article class="article-content">
  {{ if not .Params.menu }}
  <h1>{{ .Title }}</h1>
  <p class="byline">
    <time datetime='{{ .Date.Format "2006-01-02" }}' pubdate>
      {{ .Date.Format (default "2006-01-02" .Site.Params.dateFormat) }}
    </time>
    {{ with .Params.author }}Â· {{.}}{{ end }}
  </p>
  {{ end }}
  
  <content>
    {{ .Content }}
  </content>
  
  <p>
    {{ range (.GetTerms "tags") }}
      <a class="blog-tags" href="{{ .RelPermalink }}">#{{ lower .LinkTitle }}</a>
    {{ end }}
  </p>
  
  {{ if not .Params.hideReply }}
  {{ with .Site.Params.author.email }}
    <p>
      <a href='mailto:{{ . }}?subject={{ i18n "email-subject" }}"{{ default $.Site.Title $.Page.Title }}"'>
        {{ i18n "email-reply" }} â†ª
      </a>
    </p>
  {{ end }}
  {{ end }}
</article>

<!-- ç« ç¯€å°èˆªäº’å‹•è…³æœ¬ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // æª¢æŸ¥æ˜¯å¦åœ¨æ‰‹æ©Ÿç‰ˆï¼ˆéš±è— TOC æ™‚ä¸éœ€è¦åŸ·è¡Œï¼‰
  const isMobile = window.innerWidth <= 768;
  
  if (isMobile) {
    return; // æ‰‹æ©Ÿç‰ˆä¸åŸ·è¡Œ TOC ç›¸é—œåŠŸèƒ½
  }

  // ç¢ºä¿æ‰€æœ‰æ¨™é¡Œéƒ½æœ‰ ID
  const headings = document.querySelectorAll('.article-content h2, .article-content h3, .article-content h4');
  
  headings.forEach(function(heading) {
    // å¦‚æœæ²’æœ‰ IDï¼Œå‰‡ç”Ÿæˆä¸€å€‹
    if (!heading.id) {
      // å¾æ¨™é¡Œæ–‡å­—ç”Ÿæˆ ID
      const text = heading.textContent.trim();
      const id = text.toLowerCase()
        .replace(/[^\w\s-]/g, '') // ç§»é™¤ç‰¹æ®Šå­—ç¬¦
        .replace(/\s+/g, '-')     // ç©ºæ ¼æ›¿æ›ç‚ºé€£å­—ç¬¦
        .replace(/-+/g, '-')      // å¤šå€‹é€£å­—ç¬¦åˆä½µç‚ºä¸€å€‹
        .replace(/^-|-$/g, '');   // ç§»é™¤é–‹é ­å’Œçµå°¾çš„é€£å­—ç¬¦
      
      if (id) {
        heading.id = id;
      }
    }
  });

  // æ›´æ–°å´é‚Šå°èˆªé€£çµçš„ href
  const tocLinks = document.querySelectorAll('.toc-sidebar a[href^="#"]');
  tocLinks.forEach(function(link) {
    const href = link.getAttribute('href');
    if (href && href.startsWith('#')) {
      const targetId = href.substring(1);
      const targetElement = document.getElementById(targetId);
      if (targetElement) {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          targetElement.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        });
      }
    }
  });

  // æ»¾å‹•æ™‚é«˜äº®ç•¶å‰ç« ç¯€
  function updateActiveSection() {
    const sections = document.querySelectorAll('.article-content h2, .article-content h3, .article-content h4');
    const tocLinks = document.querySelectorAll('.toc-sidebar a[href^="#"]');
    
    let currentSection = '';
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    
    sections.forEach(function(section) {
      const sectionTop = section.offsetTop - 100; // æå‰ 100px è§¸ç™¼
      if (scrollTop >= sectionTop) {
        currentSection = section.id;
      }
    });
    
    // ç§»é™¤æ‰€æœ‰ active é¡åˆ¥
    tocLinks.forEach(function(link) {
      link.classList.remove('active');
    });
    
    // ç‚ºç•¶å‰ç« ç¯€æ·»åŠ  active é¡åˆ¥
    if (currentSection) {
      const activeLink = document.querySelector('.toc-sidebar a[href="#' + currentSection + '"]');
      if (activeLink) {
        activeLink.classList.add('active');
      }
    }
  }

  // ç›£è½æ»¾å‹•äº‹ä»¶
  window.addEventListener('scroll', updateActiveSection);
  
  // åˆå§‹åŒ–æ™‚åŸ·è¡Œä¸€æ¬¡
  updateActiveSection();
});
</script>
{{ end }}
